
%\input ../add/nlevel/expex-nlevel
%\input ../add/glbreak/expex-glbreak

\edef\ResetAtCatcodeInAdd{\noexpand\catcode`@=\the\catcode`@}

\catcode`\@=12
\let\temp=@
\catcode`\@=11
\let\ep@normalat=\temp
\let\ep@normalplus=+

\define@key{ling}{glbaselineskip}[\the\baselineskip]%
   {\@setinckey\skip\lingglbaselineskip#1\@nil}%
\lingset{glbaselineskip}

%%%%%%%%%%%%%%%%%%%% glbreak %%%%%%%%%%%%%%%%%%%%

\def\glw@begingl@a{%
   \ifdim\ling@glwidth=0pt
      \bgroup
   \else
      \vtop\bgroup
         \hsize=\ling@glwidth
         \leftskip=0pt
   \fi
   \glw@begingl@aa
}
\def\glw@begingl@aa{%
%\def\glw@begingl@a{%
%   \glw@begingl@b
      \@glpreamblefalse
      \rightskip=\ling@glrightskip
      \lineskiplimit=0pt
      \ifling@autoglskip
         \let\glstrut=\strut
         \epd@gllineskip=\baselineskip
         \advance\epd@gllineskip by -\dp\strutbox
         \advance\epd@gllineskip by -\ht\strutbox
         \advance\epd@gllineskip by \lingextraglskip
      \else
         \epd@gllineskip=\linggllineskip
      \fi
      \edef\gl@lineskipsave{\noexpand\lineskip=\the\lineskip}%
      \ifcase\ep@glhangstyle
         \or
            \hangindent=\ling@glhangindent
            \hangafter=1
         \or
            \glwcascade@makeshape
            \parshape 9
            \glwcascade@parshapetarget
         \fi
      \let\mainlist=\empty
      \let\aboveskiplist=\empty
      \let\strutlist=\empty
      \let\everylist=\empty
}
\def\glw@begingl@b@vtop{%
   \vtop\bgroup
      \ifdim\ling@glwidth=0pt
            \advance\hsize by -\leftskip
            \advance\hsize by -\rightskip
         \else
            \hsize=\ling@glwidth
         \fi
      \leftskip=0pt
 }
\def\glw@begingl@b@breaking{\bgroup}

\define@boolkey{ling}[ling@]{glbreaking}{%
   \ifling@glbreaking
      \let\glw@begingl@b=\glw@begingl@b@breaking
   \else
      \let\glw@begingl@b=\glw@begingl@b@vtop
   \fi}
\lingset{glbreaking=false}

% while I am at it, fix a bug
\def\glpreamble #1// {%
   \@glpreambletrue
   {\hangindent=0pt \ling@everyglpreamble #1\vskip\lingbelowpreambleskip}%
}

%%%%%%%%%%%%%%%%%%%% nlevel %%%%%%%%%%%%%%%%%%%%

\define@choicekey{ling}{glstyle}[\ling@glstyle\gl@stylenum]{wrap,nlevel}{%
   \ifcase\gl@stylenum
      \let\gl@beginglstyle\glw@begingl
      \let\endgl\glw@endgl
      \glw@assignlevels
      \let\glft=\glw@glft
   \else
      \let\gl@beginglstyle\gln@begingl
      \let\endgl\gln@endgl
      \let\glft=\gln@ft
      \fi
}
\def\gln@begingl{\bgroup
   \@glspacefalse \@getoptionalarg\gln@A}
\def\gln@A{\@ifnextchar\@cs\gln@B\gln@C}
\def\gln@B#1{\gln@C}
\def\gln@C{%
   \ling@usearg
   \baselineskip=\lingglbaselineskip
   \lineskip=\lingextraglskip
   \rightskip=\ling@glrightskip
   \ifdim\ling@glhangindent>0pt \hangindent=\ling@glhangindent
      \hangafter=1 \fi
   \leavevmode
   \gln@a
}
\newif\if@glspace
\def\gln@a{\futurelet\temp\gln@b}
\def\gln@b{\ifx\temp\endgl \let\next=\relax
   \else \ifx\temp\nogloss \let\next=\gln@bi
   \else \ifx\temp\glft \let\next=\gln@bii
   \else \let\next=\gln@c \fi\fi\fi \next }
\def\gln@bi{\expandafter\gln@c}
\def\gln@bii#1{\vskip\lingaboveglftskip\strut}
\def\gln@c #1[#2]#3 {%
   \def\tempa{\\{#1}}%
   \def\afterword{#3}%
   \gln@d #2/\@nil
   \gln@a
}
\def\nogloss#1{{#1}[]}%
%\newif\if@glspace
%\def\gln@a{\futurelet\temp\gln@b}
%\def\gln@b{\ifx\temp\endgl \let\next=\relax
%   \else \let\next=\gln@c \fi \next }
%\def\gln@c #1[#2]#3 {%
%   \def\tempa{\\{#1}}%
%   \def\afterword{#3}%
%   \gln@d #2/\@nil
%   \gln@a
%}
\def\gln@d{\@ifnextchar\@space\gln@da\gln@db}
\def\gln@da#1#2/{\gl@append #2\to\tempa \gln@e}
\def\gln@db#1/{\gl@append #1\to\tempa \gln@e}
%\def\gln@d #1/{\gl@append #1\to\tempa \gln@e}
\def\gln@e{\@ifnextchar\@nil{\gln@printcol\gln@aftercolbox\ep@gobble}\gln@d}
\def\gln@e{\@ifnextchar\@nil\gln@f\gln@d}
\def\gln@f#1{\gln@printcol\gln@aftercolbox}
\def\gln@aftercolbox{%
   \if@glspace \hskip\lingglspace \else \@glspacetrue \fi
   \box\gln@col
   \expandafter\futurelet\expandafter\temp\expandafter\gln@after@a\afterword\@nil
%   \@glspacetrue
}
\def\gln@after@a{%
   \ifx\temp\ep@normalat \let\next\gln@after@b
   \else \ifx\temp\ep@normalplus \let\next\gln@after@c
   \else \ifx\temp\@space \let\next\gln@after@d
   \else \let\next\gln@after@e
   \fi\fi\fi
   \next
}
\def\ep@diacriticerror#1{%
   \@expexerror{bad gloss diacritic: #1 (only @ and + permitted)}\end}
\def\@checkdiacritic#1#2#3{\def\temp{#2}\ifx\temp\empty #3\else
   \ep@diacriticerror{#1#2}\fi}
%   \@expexerror{bad diacritic #1#2 (only @ and + permitted)}\end \fi}
\def\gln@after@b#1#2\@nil{\@checkdiacritic{#1}{#2}\@glspacefalse}
\def\gln@after@c#1#2\@nil{\@checkdiacritic{#1}{#2}{%
   \endgraf
   \ifdim\ling@glhangindent>0pt
      \hangindent=\ling@glhangindent \hangafter=0 \fi
   \leavevmode
   \@glspacefalse}}
\def\gln@after@d#1\@nil{\@glspacetrue}
\def\gln@after@e#1\@nil{\ep@diacriticerror{#1}}

\def\gln@endgl{\par\egroup\egroup}
\newbox\gln@col
\def\gln@printcol{%
   \setbox\gln@col=\vtop{%
      \lineskip=0pt
      \ling@everyglword
      \gl@loopmoretrue
      \loop\ifgl@loopmore
         \gl@lop\tempa\to\@tempa
         \gl@lop\gln@aboveskiplist\to\@aboveskip
         \gl@lop\gln@everyline\to\@every
         \ifx\@aboveskip\empty \else
            \expandafter\ifdim\@aboveskip=0pt \else
               \vskip\@aboveskip \fi\fi
         \hbox{\@every\strut\@tempa}%
         \ifx\tempa\empty \gl@loopmorefalse \fi
      \repeat
      }%
}
\def\gln@ft{\vskip\lingaboveglftskip\strut}
\define@lingkey{glneveryline}{%
   \setlist\gln@everyline{#1}}
\define@lingkey{glnabovelineextraskip}{%
   \setlist\gln@aboveskiplist{#1}}
\def\setlist#1#2{\def#1{}\XKV@for@n{#2}\@this{%
   \expandafter\gl@append\@this\to#1}}
\lingset{glneveryline={},glnabovelineextraskip={}}

\ResetAtCatcodeInAdd


