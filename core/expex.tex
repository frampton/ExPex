\edef\resetatcatcode{\catcode`\noexpand\@\the\catcode`\@\relax}
\catcode`\@11\relax
\ifx\XKeyValLoaded\endinput \else
   \input xkeyval \fi
\ifx\ProvidesFile\@undefined
   \message{2011/07/04 v3.2 ExPex linguistics
      example formatter (JF)}
\else
   \ProvidesFile{expex.tex}[2011/07/04 v3.2
      ExPex linguistics example formatter (JF)]
   \@addtofilelist{expex.tex}
   \let\it=\itshape
\fi
% define eplain primitives, if necessary
\ifx\eplain\@undefined  % eplain stuff
\def\@futurenonspacelet#1{\def\@cs{#1}%
   \afterassignment\@stepone\let\@nexttoken= }%
\def\@stepone{\expandafter\futurelet\@cs\@steptwo}%
\def\@steptwo{\expandafter\ifx\@cs\@sptoken\let\@@next=\@stepthree
   \else\let\@@next=\@nexttoken\fi \@@next}%
\def\@stepthree{\afterassignment\@stepone\let\@@next= }%
\def\@getoptionalarg#1{%
   \let\@optionaltemp = #1%
   \let\@optionalnext = \relax
   \@futurenonspacelet\@optionalnext\@bracketcheck
}
\def\@bracketcheck{%
   \ifx [\@optionalnext
      \expandafter\@@getoptionalarg
   \else
      \let\@optionalarg = \empty
      \expandafter\@optionaltemp
   \fi
}
\def\@@getoptionalarg[#1]{%
   \def\@optionalarg{#1}%
   \@optionaltemp
}
\def\identity#1{#1}
\def\gobble#1{}
\fi
%%%%%%%%%%%%%%%%%%%%%% end of eplain inclusions
\def\epx@expandonce{\expandafter\noexpand}
\def\@getoptionaltag#1{%
   \let\@@optionaltemp = #1%
   \let\@optionaltag\empty
   \@ifnextcharacter<\@@gettag\@@optionaltemp
}
\def\@@gettag<#1>{\def\@optionaltag{#1}\@@optionaltemp}

\newif\if@tilde
\def\@tildecheck#1{%
   \@ifnextcharacter~%
      {\@tildetrue\expandafter#1\@gobble}%
      {\@tildefalse#1}%
}
\def\expandafterafter#1{\expandafter#1\expandafter}
\def\expandtwice{\expandafter\expandafter\expandafter\noexpand}
% ------ XKV parametrization ------
\def\define@lingkey{\define@key{ling}}
\def\define@ling@cmdkeys{\define@cmdkeys{ling}[ling@]}
\def\define@lingcmdkeys{\define@cmdkeys{ling}[ling]}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% inc keys
%   #1 \dimen or \skip
%   #2 bracketed default, or empty
%   #3 @ for \ling@key or empty for \lingkey
%   #4 key
\def\define@linginckey#1#2#3#4{%
   \define@key{ling}{#4}#2{%
      \expandafterafter\@setinckey
         #1\csname ling#3#4\endcsname ##1\@nil}%
}
\def\@setinckey#1#2#3#4\@nil{%
   \ifx#3!%
         #1 0=#2
         \advance#1 0 by #4
         \edef#2{\the#1 0}%
      \else
         \def#2{#3#4}%
      \fi
}
%
\def\lingset#1{\setkeys{ling}{#1}\ignorespaces}
% \Lingset first sets ling keys, if there are non-ling keys
% remaining, these are then passed to \psset
\def\Lingset#1{\setkeys*{ling}{#1}%
   \ifx\XKV@rm\@empty \else
      \expandafterafter\psset{\XKV@rm}\fi
}
\def\Ling@usearg{%
   \ifx\@optionalarg\empty
      \else \expandafterafter\Lingset{\@optionalarg}\fi
}
\def\ling@usearg{\expandafterafter\lingset{\@optionalarg}}
% styles
\def\e@let#1#2{%
   \expandafterafter\let#1\csname #2\endcsname\ignorespaces
}
\define@lingkey{lingstyle}{%
   \e@let\temp{ling@#1style}
      \expandafterafter\Lingset{\temp}}
\def\definelingstyle#1#2{%
   \expandafter\def\csname ling@#1style\endcsname{#2}}
% if PST available, allow \psset to set ling parameters,
% otherwise cancel \Lingset's ability to set PST parameters
\ifx\PSTricksLoaded\endinput
      \pst@addfams{ling}
   \else
      \let\Lingset=\lingset
   \fi
% ----- \ex -----
\newcount\excnt
\excnt=1
\newbox\numbox
\newdimen\epd@numright
\newif\if@specialexno
\def\marginoffset#1{\the\csname epd@#1\endcsname \ignorespaces}
\define@linginckey\skip{[0pt]}{}{aboveexskip}
\define@linginckey\skip{[0pt]}{}{belowexskip}
\define@linginckey\dimen{}{}{numoffset}
\define@linginckey\dimen{}{}{textoffset}
\define@ling@cmdkeys{%
   Everyex,
   everyex,
   exbreakfil,
   exbreakpenalty,
   splitpartspenalty
}
\define@lingkey{exskip}%
   {\edef\lingaboveexskip{#1}%
   \edef\lingbelowexskip{#1}%
}
\def\settosum#1#2#3{#1=#2\relax \advance#1 by#3}
\def\exns{\bgroup\@tildetrue\ex@a}
\define@choicekey{ling}{textanchor}%
   [\scratch\epx@textanchor]{numleft,normal}{}
\def\ex{\bgroup \@tildecheck\ex@a}
\def\ex@a{\def\@optionaltag{}\def\@specialexno{}%
   \@getoptionalarg\ex@b}
\def\ex@b{\@getoptionaltag\ex@c}
\def\ex@c{%
   \ex@setup
   \leavevmode
   \setbox\numbox=\hbox{\hskip\lingnumoffset\actualexnoprint}%
   \epd@numright=\wd\numbox
   \ifcase\epx@textanchor                          % numleft
         \settosum\leftskip\lingnumoffset\lingtextoffset
      \or                                         % normal
         \settosum\leftskip\epd@numright\lingtextoffset
      \fi
   \llap{\hbox to\leftskip{\unhbox\numbox \hss}}%
   \ling@everyex
   \latex@tagex
   \ignorespaces
}
\def\actualexno
   {\if@specialexno {\lingspecialexno}\else \the\excnt \fi}
\def\actualexnoprint{{\if@specialexno \specialexnoprint
   \else \exnoprint \fi}}
\def\exnoprint{(\the\excnt)}
\def\specialexnoprint{(\lingspecialexno)}
\def\globalstepexcnt{\global\advance\excnt by 1 }
\def\localstepexcnt{\advance\excnt by 1 }
\let\stepexcnt=\globalstepexcnt
\def\keepexcntlocal{\let\stepexcnt=\localstepexcnt}
\def\ex@setup{%             also used by \pex
   \global\@specialexnofalse
   \latex@tagex
   \ling@Everyex
   \let\reset@refproofing\@printref
   \let\@printref\identity    % turn off refproofing
   \Ling@usearg
   \let\@printref\reset@refproofing
   \if@specialexno
         \def\@actualexno{\lingspecialexno}%
      \else
         \edef\@actualexno{\the\excnt}%
      \fi
   \ifx\@optionaltag\empty
         \let\@localextag=\empty
      \else
         \edef\@localextag{\@optionaltag}%
         \deftag{\@actualexno}{\@optionaltag}
      \fi
   \exbreak
   \if@tilde \else \vskip\lingaboveexskip\fi
   \parindent=0pt
}
\def\noexno{\global\advance\excnt by -1}
\def\exbreak{\endgraf\bgroup\@getoptionalarg\exbreak@a}
\def\exbreak@a{%
   \ifx\@optionalarg\empty
         \skip255=\ling@exbreakfil
      \else
         \skip255= 0pt plus\@optionalarg
      \fi
   \vskip\skip255
   \penalty\ling@exbreakpenalty
   \vskip-\skip255
   \egroup
}
\def\xe{%
   \expandafter\vskip\lingbelowexskip
   \egroup
   \if@specialexno \else \stepexcnt \fi
   \allowbreak
   \prevdepth\dp\strutbox
   \noindent
}
\def\exdisplayns{\bgroup\@tildetrue\exdisplay@a}
\def\exdisplay{\bgroup\@tildecheck\exdisplay@a}
\def\exdisplay@a{\@getoptionalarg\exdisplay@b}
\def\exdisplay@b{\let\@optionaltag=\empty \ex@setup}
% ----- \pex -----
\newcount\pexcnt
\newdimen\epd@labelleft                               % NEW
\newdimen\epd@labelright                              % NEW
\newdimen\epd@textleft                                % NEW
\newdimen\epd@preambleleft                            % NEW
\newif\if@firstlabel
\define@linginckey\dimen{}{}{preambleoffset}
\define@choicekey{ling}{preambleanchor}               % NEW
   [\scratch\epx@preambleanchor]{numright,labelleft,text}{}
%\define@boolkey{ling}[ling@]{avoidnumlabelclash}{}         % NEW
\define@boolkey{ling}[ling@]{avoidnumlabelclash}[true]{}         % NEW
\define@ling@cmdkeys{appendtopexarg}                  % NEW
\define@linginckey\dimen{}{}{labelwidth}
\define@linginckey\dimen{}{}{labeloffset}
\define@lingcmdkeys{belowpreambleskip,interpartskip,splitexpenalty}
\define@choicekey{ling}{labelalign}[\ling@labelalign\nr]%
   {left,center,right}{%
      \ifcase\nr
            \def\epx@labelprint{\labelformat\epx@label\hss}%
         \or
            \def\epx@labelprint{\hss \labelformat\epx@label\hss}%
         \or
            \def\epx@labelprint{\hss \labelformat\epx@label}%
         \fi
}
\define@key{ling}{samplelabel}{%
   \setbox0=\hbox{#1}%
   \lingset{labelwidth=\wd0}%
}
\define@boolkey{ling}[ling@]{nopreamble}[true]{}
\def\pex{\bgroup\@tildecheck\pex@a}
\def\pexns{\bgroup \@tildetrue\pex@a}
\def\pex@a{\def\@optionaltag{}\def\@specialexno{}%
   \@getoptionalarg\pex@b}
\def\pex@b{%
   \ifx\ling@appendtopexarg\empty \else
      \XKV@addtolist@o\@optionalarg{\ling@appendtopexarg}\fi
   \@getoptionaltag\pex@c}
\def\pex@c{\ling@nopreambletrue
   \@futurenonspacelet\temp\pex@d}
\def\pex@d{%
   \ifx\temp\a \let\nextpex@\pex@e
      \else \ifx\temp\label \let\nextpex@\pex@f
      \else \ling@nopreamblefalse \let\nextpex@\pex@e
      \fi\fi
   \ex@setup
   \nextpex@
}
\def\pex@f#1#2{\label{#2}\@futurenonspacelet\temp\pex@g}
\def\pex@g{\ifx\temp\a \let\next\pex@h
   \else \let\next\pex@e \ling@nopreamblefalse \fi \next}
\def\pex@h#1\a{\pex@e\a}
\def\pex@e{\pex@i \ling@everyex }
\def\pex@i{%
   \setbox\numbox=\hbox{\hskip\lingnumoffset\actualexnoprint}%
   \epx@setdimensions
   \epx@pexcntinit
   \@firstlabeltrue
   \let\a\epx@putlabel
   \ifling@nopreamble
         \leftskip=\epd@textleft
      \else
         \epx@setdimpreambleleft
         \leftskip=\epd@preambleleft
      \fi
   \def\next{\llap{\hbox to\leftskip{\unhbox\numbox \hss}}}%
   \ifling@nopreamble
         \ifling@avoidnumlabelclash \let\next\relax \fi\fi
   \leavevmode
   \next
}
\def\epx@setdimensions{%
   \epd@numright=\wd\numbox
   \epd@labelleft=\linglabeloffset
      \advance\epd@labelleft by \ifcase\epx@labelanchor
         \epd@numright\or \lingnumoffset\or  0pt \fi
%   \epx@setdimlabelleft
   \settosum\epd@labelright\epd@labelleft\linglabelwidth
  \ifcase\epx@textanchor   % numleft
         \settosum\epd@textleft\lingnumoffset\lingtextoffset
      \or                 % normal
         \settosum\epd@textleft\epd@labelright\lingtextoffset
      \fi
%   \epx@setdimtextleft
}
\def\lingnumrightoffset{\the\epd@numright}%
\def\epx@setdimpreambleleft{%
   \epd@preambleleft=\lingpreambleoffset
   \advance\epd@preambleleft by \ifcase\epx@preambleanchor
      \epd@numright\or \epd@labelleft\or \epd@textleft \fi
}
\def\epx@pexcntinit{\ifnum\epx@labelgen=2\else
   \pexcnt=\ling@pexcnt
   \advance\pexcnt by -1 \fi}
\define@key[epx@]{labels}{tag}{\def\@optionaltag{#1}}
\define@key[epx@]{labels}{label}{\def\@specialexno{#1}}
\def\epx@setlabelkeys{\setkeys[epx@]{labels}}
\def\epx@useoptionallabelarg{%
   \expandafter\epx@setlabelkeys\expandafter{\@optionalarg}}
\define@lingkey{tag}{\def\@optionaltag{#1}}
\newtoks\epx@everylabel  % \epx@everylabel is a token list
\define@lingkey{everylabel}{\epx@everylabel{#1}}
%
\def\epx@putlabel{%
   \if@firstlabel
         \ifling@nopreamble \else
            \vskip\lingbelowpreambleskip
            \leftskip=\epd@textleft
            \fi
         \@firstlabelfalse
      \else
         \par\penalty\ling@splitpartspenalty
         \vskip\linginterpartskip
      \fi
   \def\@specialexno{}\def\@optionaltag{}%
   \@getoptionalarg\epx@putlabel@a
}
\def\epx@putlabel@a{%
   \epx@useoptionallabelarg
   \ifx\@specialexno\empty
         \ifcase\epx@labelgen
            \def\epx@label{\the\epx@everylabel \char\the\pexcnt}%
            \advance\pexcnt by 1
         \or
            \def\epx@label{\the\epx@everylabel \number\pexcnt}%
            \advance\pexcnt by 1
         \or
            \epx@popLL
         \or
            \def\epx@label{\the\epx@everylabel \romannumeral\pexcnt}%
            \advance\pexcnt by 1
         \fi
      \else
         \def\epx@label{\the\epx@everylabel\@specialexno}%
      \fi
   \xdef\resumepexcnt{\noexpand\pexcnt\the\pexcnt}%
   \@getoptionaltag
   \epx@putlabel@b
}
\def\epx@putlabel@b{%
   \ifx\@optionaltag\empty \else
      \deftaglabel{\@optionaltag}%
      \fi
   \leavevmode
   \llap{\hbox to\leftskip{\hskip\epd@labelleft
      \hbox to\linglabelwidth{\epx@labelprint}%
   \hfil}}%
   \latex@tagexlabel
   \ignorespaces
}
%
\define@choicekey{ling}{labelanchor}[\scratch\epx@labelanchor]%
   {numright,numleft,margin}[]{}
\define@lingkey{pexcnt}{\edef\ling@pexcnt{#1}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%----- judgments -----
\def\judge#1{\rm #1\kern .1em \ignorespaces}
\def\ljudge#1{\llap{\judge{#1}}\ignorespaces}
\define@key{ling}{*}[*]%
   {\setbox0=\hbox{#1}%
   \lingset{textoffset=!\wd0}%
}
% ----- table support -----
\define@lingcmdkeys{dima,dimb,dimc}
\lingset{dima=2.4em}
\def\tspace{\@getoptionalarg\epx@tabelspace}
\def\epx@tabelspace{\hskip
   \ifx\@optionalarg\empty
         \lingdima
      \else
         \csname ling\@optionalarg\endcsname
      \fi
}
\def\labels{\@getoptionalarg\epx@labels}
\def\epx@labels{%
   \ifcase\epx@labelgen
         \def\epx@label{\the\epx@everylabel \char\the\pexcnt}%
      \or
         \def\epx@label{\the\epx@everylabel \number\pexcnt}
      \or
      \or
         \def\epx@label{\the\epx@everylabel \romannumeral\pexcnt}
      \fi
   \ling@usearg
   \dimen0=\lingtextoffset
   \advance\dimen0 by \linglabelwidth
   \edef\ling@labelskip{\the\dimen0}%
   \epx@pexcntinit
   \let\tl\epx@inserttabellabel
   \let\nl\epx@omitlabel
   \ignorespaces
}
\def\epx@inserttabellabel{\@getoptionaltag\epx@inserttablelabel@a}
\def\epx@inserttablelabel@a{%
   \global\advance\pexcnt by 1
   \ifx\@optionaltag\empty \else
      \deftaglabel{\@optionaltag}%
      \fi
   \edef\foop{\epx@label.}\foop
}
\def\epx@omitlabel{\omit\hskip\linglabeloffset\hfil}
\def\endpextable{\egroup\egroup \par \prevdepth=\dp\strutbox}
\def\hwit#1{\hidewidth \it #1\hidewidth}
\define@linginckey\dimen{}{@}{crskip}
\lingset{crskip=.6em}
\def\crs{\cr\noalign{\vskip\ling@crskip}}
\def\crnb{\cr\noalign{\par\nobreak}}
% LL is "label list"
\define@lingkey{labellist}{%
   \edef\ling@LL{#1,}%
   \edef\@currLL{#1,}%  current LL
}
\def\epx@popLL{%
   \ifx\@currLL\empty
      \@expexwarn{Not enough labels in labellist}%
      \let\@currLL=\ling@LL  % start over
      \epx@popLL
   \else
      \expandafter\epx@popLL@a\@currLL\@nil
   \fi
}
\def\epx@popLL@a#1,#2\@nil{%
   \def\epx@label{\the\epx@everylabel #1}\def\@currLL{#2}}
\define@choicekey{ling}{labelgen}[\ling@labelgen\epx@labelgen]%
   {char,number,list,romannumeral}{}
\define@choicekey{ling}{labeltype}[\ling@labeltype\@N]%
   {alpha,caps,numeric}{%
      \ifcase\@N
            \lingset{labelgen=char,pexcnt=97,labelformat=A.,
               fullrefformat=XA,labelalign=left}%
         \or
            \lingset{labelgen=char,pexcnt=65,labelformat=A.,
               fullrefformat=XA,labeloffset=!.3em,labelalign=left}%
         \or
            \lingset{labelgen=number,pexcnt=1,labelformat=A.,
               fullrefformat=X.A,labelalign=right}%
         \fi
}
\def\definelabeltype#1#2{%
   \expandafter\def\csname ling@#1labeltype\endcsname{#2}}
\define@lingkey{labeltype}{%
   \e@let\temp{ling@#1labeltype}%
   \expandafterafter\Lingset{\temp}}
\define@lingkey{labelformat}{\epx@omitlabelformat #1\@nil}
\def\epx@omitlabelformat #1A#2\@nil{%
   \def\labelformat##1{#1{##1}#2}}
\define@lingkey{fullrefformat}{\@fullrefformat #1\@nil}
\def\@fullrefformat #1X#2A#3\@nil{%
   \def\fullrefformat##1##2{#1##1#2##2#3}}
% ----- support for LaTex \label macro -----
\let\latex@tagex\relax
\let\latex@tagexlabel\relax
\ifx\label\relax \else    % else = LaTex is loaded
   \def\latex@tagexlabel{\def\@currentlabel
      {\fullrefformat{{\the\excnt}}{\epx@label}}}%
   \def\latex@tagex{\edef\@currentlabel{\the\excnt}}%
   \fi
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\definelabeltype{alpha}{labelgen=char,pexcnt=`a,labelformat=A.,
   fullrefformat=XA,labelalign=left,labelwidth=.72em}
\definelabeltype{caps}{labelgen=char,pexcnt=`A,labelformat=A.,
   fullrefformat=XA,labelalign=left,labelwidth=.92em}
\definelabeltype{numeric}{labelgen=number,pexcnt=1,labelformat=A.,
   fullrefformat=X.A,labelalign=right,labelwidth=.75em}
\definelabeltype{footnote}{labelgen=romannumeral,pexcnt=1,labelformat=(A),
   fullrefformat=XA,labelalign=left,labelwidth=1.5em}
%%%%%
%\lingset{%
%   labeltype=alpha,
%   everylabel=,
%   labelalign=left,
%   belowpreambleskip=1ex,        % vskip after the preamble
%   interpartskip=1ex,            % vskip between parts
%   splitexpenalty=200,
%}
% ----- tags and reference -----
%
%----- local reference to example numbers -----
\def\nextx{{\@printref{ \number\excnt}}}
\def\anextx{{\@printref{\advance\excnt by 1 \number\excnt}}}
\def\lastx{{\@printref{\advance\excnt by -1 \number\excnt}}}
\def\currx{\the\excnt\relax}
\def\blastx{{\@printref{\advance\excnt by -2 \number\excnt}}}
\def\bblastx{{\@printref{\advance\excnt by -3 \number\excnt}}}
% ----- defining tags -----
\def\deftag#1#2{%
   {\let\@printref=\identity
   \expandafter\xdef\csname lingtag@#2\endcsname{{#1}}%
   \if@g@thertags
      \immediate\write@tags{\noexpand\@fd@f {#2} {{#1}} }%
      \fi}%
   \ignorespaces
}
\def\deftaglabel#1{%
   \expandafter\xdef\csname lingtag@\@localextag.#1\endcsname%
      {{{\epx@label}}%
       {{\fullrefformat{\@actualexno}\epx@label}}%
      }%
   \if@g@thertags
      \immediate\write@tags{%
         \noexpand\@fd@f
         {\@localextag.#1}
         {{{\epx@label}}%
          {{\fullrefformat{\@actualexno}\epx@label}}}%
         }%
      \fi
   \ignorespaces
}
\def\deftagex#1{\edef\@localextag{#1}%
   \expandafter\xdef\csname lingtag@#1\endcsname{{\the\excnt}}%
   \if@g@thertags
      \immediate\write@tags{\noexpand\@fd@f {#1} {{\the\excnt}}}%
      \fi
   \ignorespaces
}
\def\deftagpage#1{%
   \if@g@thertags
      \write@tags{\noexpand\@fd@f #1 {{\the\pageno}}}%
      \fi
   \ignorespaces
}
\def\lastlabel{{\epx@label}}
\def\@expexwarn#1{\immediate\write16{====> ExPex WARNING: #1.}}
\newif\if@highlightref
\@highlightreffalse
\def\refproofing{\@highlightreftrue}
\def\norefproofing{\@highlightreffalse}
\def\mathhigh@lightref#1{$\overline{\underline{\hbox{#1}}}$}
\def\psthigh@lightref{\psframebox[boxsep=false,framesep=2pt,linewidth=.2ex]}
\ifx\PSTricksLoaded\endinput
      \let\@highlightprint\psthigh@lightref
   \else
      \let\@highlightprint\mathhigh@lightref
   \fi
\def\@printref#1{%
   \if@highlightref \@highlightprint{#1}\else #1\fi}
%%%%
\newif\if@specialget
\def\specialexno@a{\futurelet\temp\specialexno@b}
\def\specialexno@b{%
   \ifx\temp\getref  \@specialgettrue
      \else \ifx\temp\getfullref \@specialgettrue
      \else \@specialgetfalse \fi\fi
   \specialexno@c
}
\def\specialexno@c #1#2#3\@nil{%
   \if@specialget
      \begingroup
      \let\@printref\gobble
      #1{#2}%
      \xdef\temp{\noexpand\edef\noexpand\lingspecialexno{\temp#3}}%
      \aftergroup\temp
      \endgroup
   \else %
      \def\lingspecialexno{#1#2#3}%
   \fi
}
\define@key{ling}{exno}{%
   \global\@specialexnotrue
   \let\latex@tagexlabel\gobble
   \let\latex@tagex\gobble
   \specialexno@a #1\relax\@nil
}
% ----- opening the tag file -----
\newif\if@g@thertags
\@g@thertagsfalse
\newwrite\ling@tagsfile
\def\write@tags{\write\ling@tagsfile}
\def\tagfilesuffix#1{\edef\@tagfilesuffix{#1}}
\def\@tagfilesuffix{-tags}
\def\gathertags{%
   \@setupreadtags
   \@g@thertagstrue
   \immediate\openout\ling@tagsfile=\jobname\@tagfilesuffix\relax
   \immediate\write@tags{\noexpand\relax}%
}
% ----- reading the tag file and defining the tags it encodes -----
\newif\if@epx@goodtagsfile
\newread\ling@tagsin
\gdef\@fd@f#1 #2 {%
   \expandafter\ifx\csname lingtag@#1\endcsname\relax
      \expandafter\gdef\csname lingtag@#1\endcsname{#2}%
      \fi
}
\newif\if@readtags
\@readtagstrue
\def\@setupreadtags{\if@readtags
   \do@readtags \global\@readtagsfalse \fi}
\def\do@readtags{%
   \immediate\openin\ling@tagsin=\jobname\@tagfilesuffix\relax
   \ifeof\ling@tagsin \else
      \closein\ling@tagsin
      {\catcode`@=11 \input \jobname\@tagfilesuffix\relax}%
   \fi
}
% ----- tagging sections, adapt to your needs -----
% If \tagsec is used with section macros that do not define
% counters \secno,\subsecno,\subsubsecno, and \subsubsubsecno,
% then \currsec must be redefined to whatever is appropriate.
%\def\chapscurrsec{\ifnum\chapno>0 \the\chapno
%   \ifnum\secno>0 .\the\secno
%   \ifnum\subsecno>0 .\the\subsecno
%   \ifnum\subsubsecno>0 .\the\subsubsecno \fi\fi\fi\fi}
%\def\nochapscurrsec{\ifnum\secno>0 .\the\secno
%   \ifnum\subsecno>0 .\the\subsecno
%   \ifnum\subsubsecno>0 .\the\subsubsecno \fi\fi\fi}
%\let\currsec\nochapscurrsec
%\def\deftagsec#1{\deftag\currsec{#1}}
%
%\def\deftaglabel#1{%
%   \expandafter\xdef\csname lingtag@\@localextag.#1\endcsname
%      {%
%      {\epx@expandonce\epx@label}%
%      {\fullrefformat{\@actualexno}\epx@expandonce\epx@label}%
%      }%
%   \ignorespaces
%}
% Uncomment and use the following for debugging if needed
%\def\reporttag#1%
%  {\writeln{\expandafter\meaning\csname lingtag@#1\endcsname}}
\def\getref@aa#1#2{#1}%
\def\getref@ab#1#2{#2}%
\def\getref#1{\getref@a{#1}\getref@aa}
\def\getfullref#1{\getref@a{#1}\getref@ab}
\def\getref@a#1#2{%
   \if@readtags \@setupreadtags \fi
   \expandafter \ifcsname lingtag@#1\endcsname
         \edef\temp{\expandtwice\csname lingtag@#1\endcsname}%
         \ifx\temp\empty
               \@expexwarn{+++tag #1 has no full reference}%
               \@printref{Missing!}%
            \else
               {\@printref{\temp}}%
            \fi
      \else
         \@expexwarn{tag #1 is called but not defined}%
         {\@printref{\tt [#1]}}%
      \fi
}
\newif\ifpartlabel
\newif\iffullref
\def\ispartlabelcheck#1{\ispart@a#1.\@nil}
\def\ispart@a#1.#2\@nil{\def\temp{#2}%
   \ifx\temp\empty \partlabelfalse \else \partlabeltrue\fi}
\def\getref{\fullreffalse \getref@a}
\def\getfullref{\fullreftrue \getref@a}
%\def\getref@a#1{%
%   \if@readtags \@setupreadtags \fi
%   \ispartlabelcheck{#1}%
%   \ifpartlabel
%         \iffullref
%               \let\@chooseref\chooseref@a
%            \else
%               \let\@chooseref\chooseref@g
%            \fi
%      \else
%         \let\@chooseref\relax
%      \fi
%   \expandafter \ifcsname lingtag@#1\endcsname
%   \edef\temp{\expandtwice\csname lingtag@#1\endcsname}%
%   \ifx\temp\empty
%            \@expexwarn{+++tag #1 has no full reference}%
%            \@printref{Missing!}%
%         \else
%            {\@printref{\expandafter\@chooseref\temp}}%
%         \fi
%      \else
%         \@expexwarn{tag #1 is called but not defined}%
%         {\@printref{\tt [#1]}}%
%      \fi
%}
\def\getref@a#1{%
   \if@readtags \@setupreadtags \fi
   \ispartlabelcheck{#1}%
   \ifpartlabel
         \iffullref
               \let\@chooseref\chooseref@a
            \else
               \let\@chooseref\chooseref@g
            \fi
      \else
         \let\@chooseref\relax
      \fi
   \expandafter\ifx\csname lingtag@#1\endcsname \relax
         \@expexwarn{tag #1 is called but not defined}%
         {\@printref{\tt [#1]}}%
      \else
         \expandafter\let\expandafter\temp
            \csname lingtag@#1\endcsname
         \@printref{\expandafter\@chooseref\temp}%
      \fi
}
\def\chooseref@a#1#2{#2}
\def\chooseref@g#1#2{#1}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% glosses
\define@choicekey{ling}{glstyle}[\ling@glstyle\gl@stylenum]%
   {wrap,3level,oldstyle,multilevel,multiwrap}{%
% \ling@glstylenum is used to identify wrap style, so it should stay first
      \ifcase\gl@stylenum
            \let\gl@beginglstyle\glw@begingl
            \let\endgl\glw@endgl
            \glw@assignlevels
            \let\glft=\glw@glft
         \or
            \let\gl@beginglstyle=\glT@begingl
            \let\endgl\endgl@T
            \glw@assignlevels
            \let\glft=\glw@glft
         \or
            \let\gl@beginglstyle=\begingl@L
            \let\endgl=\endgl@L
            \let\gla=\gla@L
            \let\glb=\glb@L
            \let\glc=\glc@L
         \or
            \let\gl@beginglstyle=\begingl@L
            \let\endgl=\endgl@L
            \glm@assignlevels
            \let\glft=\glft@M
         \fi
}
\def\ling@glstyle{wrap}
\def\glm@assignlevels{%
   \expandafter\XKV@for@n\expandafter{\glm@levels}\levelname
   {\edef\temp{\noexpand\let
   \expandafter\noexpand\csname gl\levelname\endcsname
   \expandafter\noexpand\csname gl\levelname @M\endcsname}%
   \temp}%
}
\def\glw@assignlevels{%
   \expandafter\XKV@for@n\expandafter{\glw@levels}\levelname
   {\edef\temp{\noexpand\let
   \expandafter\noexpand\csname gl\levelname\endcsname
   \expandafter\noexpand\csname glw@gl\levelname\endcsname}%
   \temp}%
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\begingl{\bgroup\@getoptionalarg\gl@begingl}
\def\gl@begingl{\ling@usearg\gl@beginglstyle}
\define@linginckey\dimen{}{@}{glspace}
%\define@ling@cmdkeys{everygla,everyglb,everyglc}
\define@ling@cmdkeys{everygla,everyglb,everyglc,
   everygl,everyglft,everyglword}
\define@linginckey\dimen{}{@}{glhangindent}
\define@linginckey\dimen{}{@}{glwidth}
\define@linginckey\skip{}{@}{aboveglftskip}
%--------------- Wrap style (W) ---------------------------
\define@choicekey{ling}{glhangstyle}[\temp\epx@glhangstyle]%
   {none,normal,cascade}{}
\define@ling@cmdkeys{glrightskip}
\lingset{glhangstyle=normal,glrightskip=0pt plus .25\hsize}
%\def\begingl@Wb{%
%   \bgroup
%   \parindent=0pt
%   \W@prefixboxfalse
%   \@ifnextchar\gla@W\begingl@W@aux\begingl@W@withprefix
%}
%\def\endgl@Wb{\egroup\egroup\egroup}
%\def\begingl@W@aux{%
%   \leavevmode
%   \ifW@prefixbox \box\W@prefixbox \fi
%   \vtop\bgroup
%   \ling@usearg
%   \ling@everygl
%   \ifdim\ling@glwidth=0pt
%         \advance\hsize by -\leftskip
%         \advance\hsize by -\rightskip
%      \else
%         \hsize=\ling@glwidth
%      \fi
%   \ifW@prefixbox \advance\hsize by -\W@prefixboxwd \fi
%   \parindent=0pt
%   \rightskip=0pt plus 1fil
%   \leftskip=\ling@glhangindent
%   \hskip-\ling@glhangindent
%   \leavevmode
%}
%\def\begingl@W@aux{%
%   \leavevmode
%   \ifW@prefixbox \box\W@prefixbox \fi
%   \vtop\bgroup
%      \ling@usearg
%      \ling@everygl
%      \ifdim\ling@glwidth=0pt
%            \advance\hsize by -\leftskip
%            \advance\hsize by -\rightskip
%         \else
%            \hsize=\ling@glwidth
%         \fi
%      \ifW@prefixbox \advance\hsize by -\W@prefixboxwd \fi
%      \rightskip=\ling@glrightskip
%      \ifcase\epx@glhangstyle
%            \leftskip=0pt
%         \or
%            \leftskip=\ling@glhangindent
%            \hskip -\ling@glhangindent
%         \or
%            \leftskip=0pt
%            \epx@makeshape
%            \parshape 9
%            \epx@parshapetarget
%         \fi
%}
%\newbox\W@prefixbox
%\newdimen\W@prefixboxwd
%\def\begingl@W@withprefix #1\gla{%
%   \W@prefixboxtrue
%   \setbox\W@prefixbox=\hbox{#1}%
%   \W@prefixboxwd=\wd\W@prefixbox
%   \begingl@W@aux\gla@W
%}
%\def\glft@W{\leavevmode\leftskip=0pt \@tildecheck\glft@W@a}
%\def\glft@W@a #1//{%
%   \if@tilde \else \vskip\ling@aboveglftskip \fi
%   \strut #1
%   \noindent\ling@everyglft\strut #1
%}
%\def\gla@W{\@getoptionalarg\gla@W@a}
%\def\gla@W@a#1// {%
%   \bgroup
%   \ling@usearg
%   \def\topline{}%
%   \def\botline{}%
%   \leavevmode\gla@W@b #1 \@nil}
%\def\gla@W@b{\@ifnextchar\@nil\gla@W@d\gla@W@c}
%\def\gla@W@c#1 {\addtoline\topline{#1}\gla@W@b}
%\def\gla@W@d#1{}
%\def\glb@W#1// {\leavevmode\glb@W@a#1 \@nil}
%\def\glb@W@a{\@ifnextchar\@nil\mk@pairline\glb@W@b}
%\def\glb@W@b#1 {\addtoline\botline{#1}\glb@W@a}
%\def\glc@W{\par\nobreak\prevdepth=.28\baselineskip \@getoptionalarg\glc@W@}
%\long\def\glc@W@#1\endgl{\par\leftskip=0pt
%   {\ling@usearg\vskip\ling@aboveglcskip
%   \ling@everyglc #1\strut\par}\egroup\egroup}
%\def\glft@Wb{\@tildecheck\glft@Wb@a}
%\def\glft@Wb@a #1//{%
%   \if@tilde \par \else \vskip\ling@aboveglftskip \fi
%   \nobreak\prevdepth=.28\baselineskip
%   \leavevmode
%   \ling@everyglft
%   \leftskip=0pt
%   \noindent\strut #1%
%}
% ----- side by side (ss) gloss style -----
\define@choicekey{ling}{glftpos}[\temp\epx@glftpos]%
   {below,right}{%
      \ifcase\epx@glftpos
         \let\gl@beginglstyle\glw@begingl
         \let\endgl\glw@endgl
         \let\glft=\glw@glft
      \or
         \let\gl@beginglstyle=\glw@ss@begingl
         \let\endgl=\glw@ss@endgl
         \let\glft\glw@ss@glft
      \fi
}
\define@lingcmdkeys{sssep,ssratio,ssrightskip}
\lingset{sssep=2em,ssratio=.6,ssrightskip=0pt plus 2em}
\newdimen\ssleftwd
\newdimen\ssrightwd
\def\glw@ss@begingl{%
   \dimen0 =\hsize
   \advance\dimen0 by -\leftskip
   \advance\dimen0 by -\lingsssep
   \ssleftwd=\lingssratio\dimen0
   \ssrightwd=\dimen0
   \advance\ssrightwd by -\ssleftwd
   \leavevmode\bgroup\hbox\bgroup
      \hsize=\ssleftwd
      \lingset{glwidth=\ssleftwd}
      \glw@begingl
}
\def\glw@ss@endgl{\egroup\egroup}
\def\glw@ss@glft #1//{%
   \glw@endgl
   \hskip\lingsssep
   \vtop{%
      \leftskip=0pt
      \rightskip=\lingssrightskip
      \parindent=0pt
      \hsize=\ssrightwd
      \ling@everyglft
      #1}%
      \ignorespaces
}
% ----- plumbing needed for cascading hanging indentation -----
\newdimen\glwcascade@pshapeindent
\newdimen\glwcascade@pshapelinewd
\def\glwcascade@parshapetarget{}
\def\glwcascade@mkshapeaux{%
   \edef\glwcascade@parshapetarget
      {\glwcascade@parshapetarget\space
         \the\glwcascade@pshapeindent\space\the\glwcascade@pshapelinewd}%
   \advance\glwcascade@pshapeindent by \ling@glhangindent
   \advance\glwcascade@pshapelinewd by -\ling@glhangindent
}
\def\glwcascade@mkshapeauxaux{\glwcascade@mkshapeaux\glwcascade@mkshapeaux
   \glwcascade@mkshapeaux}
\def\glwcascade@makeshape{%
   \glwcascade@pshapeindent=0pt
   \glwcascade@pshapelinewd=\hsize
   \glwcascade@mkshapeaux\glwcascade@mkshapeaux
   \glwcascade@mkshapeaux\glwcascade@mkshapeaux
}
\def\glwcascade@makeshape{%
   \glwcascade@pshapeindent=0pt
   \glwcascade@pshapelinewd=\hsize
   \glwcascade@mkshapeauxaux\glwcascade@mkshapeauxaux\glwcascade@mkshapeauxaux
}
%---------------------- Wrap style (w) ---------------------
\newtoks\gltoks@a
\newtoks\gltoks@b
\def\glw@append #1\to #2{%
   \gltoks@a={\\{#1}}%
   \gltoks@b=\expandafter{#2}%
   \xdef#2{\the\gltoks@b\the\gltoks@a}%
}
\def\glw@lop#1\to#2{\ifx#1\empty
   \let#2\empty \else\expandafter\glw@lopoff#1\glw@lopoff#1#2\fi}
\long\def\glw@lopoff\\#1#2\glw@lopoff#3#4{\def#4{#1}\def#3{#2}}
\newif\ifgl@loopmore
\def\glw@mergerow#1\to #2{%
   \let\alist=#1%
   \let\blist=#2%
   \let\clist=\empty
   \gl@loopmoretrue
   \loop \ifgl@loopmore\glw@mergerow@a \repeat
   \global\let#2=\clist
}
\def\glw@mergerow@a{%
   \glw@lop\blist\to\tempb
   \ifx\tempb\Linebreak
         \expandafter\glw@append\Linebreak\to\clist
      \else\ifx\tempb\Closeup
         \expandafter\glw@append\Closeup\to\clist
      \else\ifx\tempb\Lbrack
         \expandafter\glw@append\Lbrack\to\clist
      \else\ifx\tempb\Rbrack
         \expandafter\glw@append\Rbrack\to\clist
      \else
         \glw@lop\alist\to\tempa
         \expandafter\glw@append \tempa \to \tempb
         \expandafter\glw@append \tempb \to \clist
      \fi\fi\fi\fi
   \ifx\alist\empty \ifx\blist\empty \gl@loopmorefalse \fi\fi
}
\def\\{\noexpand\\}
\newdimen\glw@maxht
\newdimen\glw@maxdp
\def\Closeup{@}\@onelevel@sanitize\Closeup
\def\Linebreak{+}\@onelevel@sanitize\Linebreak
\def\Lbrack{[}\@onelevel@sanitize\Lbrack
\def\Rbrack{]}\@onelevel@sanitize\Rbrack
\def\glw@gla{%
   \def\gl@linelabel{a}%
   \glw@maxht=0pt
   \glw@maxdp=0pt
   \@getoptionalarg
   \glw@gla@a
}
\def\glw@gla@a #1// {\bgroup\ling@usearg
   \glw@gla@b #1 \@nil }
\def\glw@gla@b{\@ifnextchar\@nil\glw@gla@c\glw@gla@d}
\def\glw@gla@c#1{\glw@updateauxlistsA \egroup}
\def\glw@gla@d #1 {%
   \def\tempa{#1}\let\tempb=\tempa
   \@onelevel@sanitize\tempa
   \setbox0=\hbox{\ling@everygla #1}%
   \ifdim\glw@maxht<\ht0 \glw@maxht=\ht0 \fi
   \ifdim\glw@maxdp<\dp0 \glw@maxdp=\dp0 \fi
   \ifx\tempa\Linebreak
         \expandafter\glw@append\Linebreak\to\mainlist
      \else\ifx\tempa\Closeup
         \expandafter\glw@append\Closeup\to\mainlist
      \else\ifx\tempa\Lbrack
         \expandafter\glw@append\Lbrack\to\mainlist
      \else\ifx\tempa\Rbrack
         \expandafter\glw@append\Rbrack\to\mainlist
      \else
         \edef\temp{\noexpand\\{\expandonce\ling@everygla
            \expandonce\tempb}}%
         \expandafter\glw@append\temp\to\mainlist
      \fi\fi\fi\fi
   \glw@gla@b
}
\def\glw@updateauxlistsA{%
   \let\temp=\empty
   \glw@updateaux@a
}
\def\glw@updateauxlistsB{%
   \edef\temp{\vskip\csname ling@abovegl\gl@linelabel skip\endcsname}%
   \glw@updateaux@a
}
\def\glw@updateaux@a{%
   \expandafter\glw@append\temp \to\aboveskiplist
   \edef\temp{\vrule width0pt height\the\glw@maxht\space depth\the\glw@maxdp\space }%
   \expandafter\glw@append\temp\to\strutlist
}
\def\gl@stylenum{0}
\def\glw@levels{a,ft}
\def\define@glwlevel#1{%
   \expandafter\ifx\csname glw@gl#1\endcsname\relax
      \define@ling@cmdkeys{everygl#1}%
      \define@linginckey\skip{}{@}{abovegl#1skip}%
      \XKV@addtolist@o\glw@levels{#1}%
      \lingset{everygl#1=,abovegl#1skip=0pt}
      \expandafter\def\csname glw@gl#1\endcsname{\glw@glx{#1}}%
   \else
      \message{>>>>ExPex Warning: Level #1 is already defined.}%
   \fi
}
\def\defineglwlevels#1{\XKV@for@n{#1}\thislevel
   {\expandafter\define@glwlevel\expandafter{\thislevel}}%
   \ifnum\gl@stylenum=0 \lingset{glstyle=wrap}\fi
}
\def\glw@glx#1{%   x suggests any label (as argument to \glw@glx)
   \def\worklist{}%
   \glw@maxht=0pt
   \glw@maxdp=0pt
   \def\gl@linelabel{#1}%
   \@getoptionalarg\glw@glx@a
}
\def\glw@glx@a #1// {\bgroup
   \ling@usearg
   \glw@glx@b #1 \@nil }
\def\glw@glx@b{\@ifnextchar\@nil\glw@glx@c\glw@glx@d}
\def\glw@glx@c#1{\glw@updateauxlistsB \glw@mergerow\worklist\to\mainlist\egroup}
\def\glw@glx@d #1 {%
   \def\tempa{#1}%
   \edef\temp{%
      \expandafter\expandonce\csname ling@everygl\gl@linelabel\endcsname
      \expandonce\tempa}%
   \setbox0=\hbox{\temp}%
   \ifdim\glw@maxht<\ht0 \glw@maxht=\ht0 \fi
   \ifdim\glw@maxdp<\dp0 \glw@maxdp=\dp0 \fi
   \expandafter\glw@append\temp\to\worklist
   \glw@glx@b
}
\defineglwlevels{b}
\def\glw@endgl{\glw@endglA \glw@endglB}
\def\glw@endglA{\lineskip=\ling@abovemoreglskip \glw@print \par}
\def\glw@endglB{\egroup\egroup}
\newif\ifglw@spacebefore
\newif\ifW@prefixbox
\newbox\W@prefixbox
\newdimen\W@prefixboxwd
\def\glw@begingl{%
   \parindent=0pt
   \W@prefixboxfalse
   \@ifnextchar\gla\glw@begingl@noprefix\glw@begingl@prefix
}
\def\glw@begingl@noprefix{%
   \vtop\bgroup
      \ling@usearg
      \ifdim\ling@glwidth=0pt
            \advance\hsize by -\leftskip
            \advance\hsize by -\rightskip
         \else
            \hsize=\ling@glwidth
         \fi
      \ifW@prefixbox \advance\hsize by -\W@prefixboxwd \fi
      \ling@everygl
      \rightskip=\ling@glrightskip
      \ifcase\epx@glhangstyle
            \leftskip=0pt
         \or
            \leftskip=\ling@glhangindent
            \hskip -\ling@glhangindent
         \or
            \leftskip=0pt
            \glwcascade@makeshape
            \parshape 9
            \glwcascade@parshapetarget
         \fi
      \let\mainlist=\empty
      \let\aboveskiplist=\empty
      \let\strutlist=\empty
}
\def\glw@begingl@prefix #1\gla{%
   \W@prefixboxtrue
   \setbox\W@prefixbox=\hbox{#1}%
   \W@prefixboxwd=\wd\W@prefixbox
   \unhbox\W@prefixbox
   \glw@begingl@noprefix \gla
}
\def\glw@glft#1//{%
   {\lineskip=\ling@abovemoreglskip
   \glw@print \vskip\ling@aboveglftskip}%
   \leftskip=0pt
   \parshape 0
   \let\endgl=\glw@endglB
   #1\par
}
\def\glw@print{%
   \glw@spacebeforefalse
   \@glpostbrackfalse
   \leavevmode
   \gl@loopmoretrue
   \@glaparsestate=1
   \loop\ifgl@loopmore
      \glw@lop\mainlist\to\tempa\relax       % \tempa is one column
      \ifx\tempa\Linebreak
            \vskip\ling@abovemoreglskip
            \@glaparsestate=1
            \leavevmode
         \else\ifx\tempa\Closeup
            \@glaparsestate=1
         \else\ifx\tempa\Lbrack
            \ifnum\@glaparsestate=0 \hskip\ling@glspace
               \else\ifnum\@glaparsestate=2 \hskip\lingglbrackbracksep
               \else\ifnum\@glaparsestate=3 \hskip\ling@glspace
               \fi\fi\fi
            \printlbrack\nobreak
            \@glaparsestate=2
         \else\ifx\tempa\Rbrack
            \nobreak
            \ifnum\@glaparsestate=0 \hskip\lingglbrackwordsep
               \else\ifnum\@glaparsestate=2 \hskip\ling@glspace
               \else\ifnum\@glaparsestate=3 \hskip\lingglbrackbracksep
               \fi\fi\fi
            \printrbrack
            \@glaparsestate=3
         \else
            \ifnum\@glaparsestate=0 \hskip\ling@glspace
               \else\ifnum\@glaparsestate=2 \hskip\lingglbrackwordsep
               \else\ifnum\@glaparsestate=3 \hskip\ling@glspace
               \fi\fi\fi
            \@glaparsestate=0
            \glw@printcol
         \fi\fi\fi\fi
      \ifx\mainlist\empty \gl@loopmorefalse \fi
      \repeat
}
\def\glw@printcol{%
   \vtop{%
      \ling@everyglword
      \gl@loopmoretrue
      \loop\ifgl@loopmore
         \glw@lop\tempa\to\@tempa
         \glw@lop\aboveskiplist\to\@aboveskip
         \glw@lop\strutlist\to\@strut
         \@aboveskip\hbox{\@strut\@tempa}%
         \ifx\tempa\empty \gl@loopmorefalse \fi
      \repeat
      }%
}
%---------------------- 3 level style (T) ---------------------
\def\glT@addtoline#1#2{\ifx#1\empty\gltoks@a={{#2}}\else\gltoks@a={&{#2}}\fi
   \gltoks@b=\expandafter{#1}%
   \edef#1{\the\gltoks@b\the\gltoks@a}}
\def\glT@begingl{\@emptyc@linetrue
   \def\a@line{}\def\b@line{}\def\c@line{}\glT@@a
}
\newif\if@emptyc@line
\def\glT@@a#1{\glT@@b#1///\@nil \glT@@c}
\def\glT@@b#1/#2/#3/#4\@nil{%
   \glT@addtoline\a@line{\ling@everygla #1}%
   \glT@addtoline\b@line{\ling@everyglb #2}%
   \def\temp{#3}\ifx\temp\empty \else \@emptyc@linefalse\fi
   \glT@addtoline\c@line{\ling@everyglc #3}%
}
\def\glT@@c{\@futurenonspacelet\temp\glT@@d}
\def\glT@@d{\ifx\temp.\let\next\glT@@e\else\let\next\glT@@a\fi\next}
\def\glT@@e#1#2\endgl{\def\linefour{\ignorespaces #2}\glT@@f}
\def\glT@@f{%
   \vtop{\ling@everygl
   \halign{##\hfil&& \hskip\ling@glspace ##\hfil\cr
      \a@line\cr
      \ifdim\ling@aboveglbskip=0pt
         \else \noalign{\vskip\ling@aboveglbskip}\fi
      \b@line\cr
      \if@emptyc@line \else
         \ifdim\ling@aboveglcskip=0pt
            \else \noalign{\vskip\ling@aboveglcskip}\fi
         \c@line\cr
         \fi
      \ifx\linefour\empty \else
         \ifdim\ling@aboveglftskip=0pt
            \else \noalign{\vskip\ling@aboveglftskip}\fi
         \ling@everyglft \linefour\hidewidth\cr
         \fi
   }}%
\egroup
}
%------------------- multilevel style (M) ---------------------
\def\glm@levels{}
\def\define@gl@level#1{%
   \define@ling@cmdkeys{everygl#1}
   \define@linginckey\skip{}{@}{abovegl#1skip}
   \XKV@addtolist@o\glm@levels{#1}%
   \lingset{everygl#1=,abovegl#1skip=0pt}
   \edef\@above{\epx@expandonce\csname ling@abovegl#1skip\endcsname}%
   \expandafter\edef\csname gl#1@M\endcsname{%
      \noexpand\ifdim\epx@expandonce\@above=0pt \noexpand\else
         \noexpand\noalign{\noexpand\vskip \epx@expandonce\@above}%
         \noexpand\fi
      \noexpand\global\noexpand\let\noexpand\@everygl
         \epx@expandonce\csname ling@everygl#1\endcsname
      \noexpand\glm@parser}%\fi
}
\def\defineglmlevels#1{\XKV@for@n{#1}\@X
   {\expandafter\define@gl@level\expandafter{\@X}}}
\def\glm@parser #1//{\gltoks@a={#1 /}\expandafter\gloss@L\the\gltoks@a}
\defineglmlevels{a,b,c}
\def\glft@M{\noalign\bgroup\@tildecheck\glft@M@a}
\def\glft@M@a #1//{%
   \if@tilde \else \vskip\ling@aboveglftskip \fi \egroup
   \omit\rlap{\advance\hsize by -\leftskip
      \vtop{\parindent=0pt \leftskip=0pt
         \ling@everyglft #1\strut}}\hfil\cr
}
%---------------------- old style (L) -------------------------
\define@linginckey\skip{}{@}{abovemoreglskip}
%\define@linginckey\skip{}{@}{aboveglcskip}
\define@linginckey\dimen{}{@}{moregloffset}
\def\begingl@L{%
   \leavevmode
   \vtop\bgroup
   \ling@usearg
   \vtop\bgroup
      \halign\bgroup ##\hfil &&
         \kern\ling@glspace ##\hfil\cr
}
\def\moregl{%
   \egroup\egroup \vskip\ling@abovemoreglskip
   \vtop\bgroup
      \halign\bgroup \kern\ling@moregloffset ##\hfil &&
         \kern\ling@glspace ##\hfil\cr
}
\def\endgl@L{\egroup\egroup\egroup\egroup}
\def\gla@L{\global\let\@everygl\ling@everygla \gloss@L}
\def\glb@L{\global\let\@everygl\ling@everyglb \gloss@L}
\def\gloss@L #1 {\@everygl #1\@ifnextchar/{\strut\cr\@gobble}{&
\gloss@L}}
\def\glc@L{\noalign\bgroup\@tildecheck\glc@L@a}
\def\glc@L@a #1{%
   \if@tilde \else \vskip\ling@aboveglcskip \fi \egroup
   \omit \ling@everyglc #1\strut\hidewidth\cr
}



\newif\if@glpostbrack
\newcount\@glaparsestate          % 0 normal, 1 post @, 2 post [, 3 post ]
\define@linginckey\dimen{}{}{glbrackbracksep}
\define@linginckey\dimen{}{}{glbrackwordsep}
\def\printrbrack{$]$}
\def\printlbrack{$[$}
\lingset{glbrackbracksep=.05em,glbrackwordsep=.1em}
% ----- underfixes -----
\def\gluf#1#2{%
   \vtop{\offinterlineskip\halign{\hfil##\hfil\cr
      \strut #1\cr
      \noalign{\vskip-\ling@glufcloseup}
      \ling@everygluf \strut#2\cr
}}}
\define@ling@cmdkeys{everygluf}
\define@linginckey\dimen{}{@}{glufcloseup}
\lingset{glufcloseup=.4ex,everygluf=\sc}    % underfix parameters
%
% ----- gloss comments and citations -----
\def\rightcomment#1{\rlap{\advance\hsize by -\leftskip
   \hbox to\hsize{\hfil #1}}\ignorespaces}
\let\rightcite=\rightcomment % for backwards compatability
\def\leftcomment#1{\llap{\hbox to\leftskip{#1\hfil}}}
\define@ling@cmdkeys{mincitesep}
\lingset{mincitesep=1.5em}
\def\pushciteright#1{%
   \hskip\ling@mincitesep plus 1fill
   \penalty100\null\nobreak \hskip 0pt plus 1fill
   \hbox{#1}%
}
\resetatcatcode
% ----- initial settings -----
\def\normalexskip{2.7ex plus .8ex minus .8ex}
\definelingstyle{factorysettings}{%
   aboveexskip=\normalexskip,
   belowexskip=\normalexskip,
   Everyex=,
   everyex=,
   numoffset=0pt,
   labelanchor=numright,
   labeloffset=1em,
   labelwidth=.78em,
   textanchor=normal,
   textoffset=1em,
   preambleanchor=numright,
   preambleoffset=1em,
   avoidnumlabelclash=false,
   appendtopexarg=,
   labeltype=alpha,
   everylabel=,
   labelalign=left,
   belowpreambleskip=1ex,
   interpartskip=1ex,
   splitexpenalty=200,
   exbreakfil=0pt plus 4ex,
   exbreakpenalty=-50,
   splitpartspenalty=200,
% parameters used in glosses
   glspace=.6em,
   aboveglcskip=0pt,
   aboveglftskip=1ex,
   glhangindent=1em,
   everygla=\it,
   everyglb=,
   everyglc=,
   everyglft=,
   everygl=,
   everyglword=,
   glwidth=0pt,
   glufcloseup=.4ex,
   everygluf=\sc,
%   everybracket=\rm,
%   glbracketsep=.15em,
   glstyle=oldstyle,
   moregloffset=0pt,
   abovemoreglskip=.25ex,
   mincitesep=1.5em,
% auxiliary parameters used for building tables
   dima=2.4em,
   crskip=.6em
}
\lingset{lingstyle=factorysettings}
%---- psuedo-parameters, which have no default settings
% samplelabel, *
%
% addons can be put in expex-add.tex
%%% TEMPORARY TURNOFF
%\newread\expexsupp
%\openin\expexsupp = expex-add.tex
%\ifeof\expexsupp \else
%   \closein\expexsupp
%   \input expex-add
%   \fi
%%% END TEMPORATY TURNOFF
% can be used to (always) override factory settings

