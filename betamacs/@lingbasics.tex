
\def\writeln#1{\immediate\write16{#1}\ignorespaces}
\def\makeatletter{%
  \edef\resetatcatcode{\catcode`\noexpand\@\the\catcode`\@\relax}%
  \catcode`\@11\relax
}%
\makeatletter
\toks0={%
\def\@futurenonspacelet#1{\def\cs{#1}%
   \afterassignment\@stepone\let\@nexttoken=
}%
%\begingroup % The grouping here avoids stepping on an outside use of `\\'.
%\def\\{\global\let\@stoken= }%
%\\ % now \@stoken is a space token (\\ is a control symbol, so that
%\endgroup
\def\@stepone{\expandafter\futurelet\cs\@steptwo}%
\def\@steptwo{\expandafter\ifx\cs\@sptoken\let\@@next=\@stepthree
   \else\let\@@next=\@nexttoken\fi \@@next}%
\def\@stepthree{\afterassignment\@stepone\let\@@next= }%
\def\@getoptionalarg#1{%
   \let\@optionaltemp = #1%
   \let\@optionalnext = \relax
   \@futurenonspacelet\@optionalnext\@bracketcheck
}%
\def\@bracketcheck{%
   \ifx [\@optionalnext
      \expandafter\@@getoptionalarg
   \else
      \let\@optionalarg = \empty
      \expandafter\@optionaltemp
   \fi
}%
\def\@@getoptionalarg[#1]{%
   \def\@optionalarg{#1}%
   \@optionaltemp
}%
\def\identity#1{#1}%
}%
% all code above taken from EPlain
\ifx\eplain\undefined \the\toks0 \fi
%\ifx\PSTricksLoaded\endinput \else
%   \input ./betamacs/expex-hdr \fi
\ifx\XKeyValLoaded\endinput \else
   \input xkeyval \fi
\newif\if@tilde
\def\@tildecheck#1{%
   \@ifnextcharacter&%
      {\@tildetrue\expandafter#1\@gobble}%
      {\@tildefalse#1}%
}
%\def\@gobbleignore#1{\ignorespaces}
% ------ XKV parameters ------
\def\definelingkey{\define@key[jXKV]{ling}}
\def\definelinginckey#1{%
   \define@key[jXKV]{ling}{#1}%
      {\expandafter\setinckey\csname ling@#1\endcsname##1\@nil}%
}
\def\definelinginckeys#1{%
   \XKV@for@n{#1}\@key
      {\edef\temp{\expandafter\@stripsptoken\@key\@nil}%
         \expandafter\definelinginckey\expandafter{\temp}}%
}
\def\@stripsptoken #1#2\@nil{\ifx#1\@sptoken \else #1\fi #2}
\def\defineuserlinginckey#1{%
   \define@key[jXKV]{ling}{#1}%
      {\expandafter\setinckey\csname ling#1\endcsname##1\@nil}%
}
\def\defineuserlinginckeys#1{%
   \XKV@for@n{#1}\@key
      {\edef\temp{\expandafter\@stripsptoken\@key\@nil}%
         \expandafter\defineuserlinginckey\expandafter{\temp}}%
}
\def\setinckey#1#2#3\@nil{%
   \ifx#2!%
      \dimen0=#1
      \advance\dimen0 by #3
   \else
      \dimen0=#2#3
   \fi
   \edef#1{\the\dimen0}%
}
\def\lingset{\setkeys[jXKV]{ling}}
% \Lingset first sets ling keys, if there are non-ling keys
% remaining, these are then passed to \psset
\def\Lingset#1{\setkeys*[jXKV]{ling}{#1}%
   \ifx\XKV@rm\@empty \else
   \expandafter\psset\expandafter{\XKV@rm}\fi}
\def\Ling@usearg{\expandafter\Lingset\expandafter{\@optionalarg}}
\def\ling@usearg{\expandafter\lingset\expandafter{\@optionalarg}}
\def\definelingcmdkeys{\define@cmdkeys[jXKV]{ling}[ling@]}
\def\definelingcmdkey#1{\define@cmdkey[jXKV]{ling}[ling@]{#1}[]{}}
\def\definelingboolkeys{\define@boolkeys[jXKV]{ling}[ling@]}
\def\definelingboolkey#1{\define@boolkey[jXKV]{ling}[ling@]{#1}[]{}}
% styles
\definelingkey{lingstyle}{%
   \edef\temp{\csname ling@#1style\endcsname}%
      \expandafter\Lingset\expandafter{\temp}}
\def\definelingstyle#1#2{%
   \expandafter\def\csname ling@#1style\endcsname{#2}}
% if PST, allow \psset to set ling parameters, otherwise
% cancel \Lingset's ability to set PST parameters
\ifx\PSTLoaded
   \pst@addfams{ling}
\else
   \let\Lingset=\lingset
\fi

\resetatcatcode
